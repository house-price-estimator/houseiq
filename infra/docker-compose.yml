services:
  ml:
    build:
      context: ../houseiq-ml
    container_name: houseiq-ml
    environment:
      - MODEL_PATH=/app/model.joblib
      - META_PATH=/app/model_meta.json
    ports:
      - "8000:8000"
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:8000/health"]
      interval: 10s
      timeout: 3s
      retries: 10

  backend:
    build:
      context: ../houseiq-backend
    container_name: houseiq-backend
    environment:
      # ---- Mongo: choose ONE of the two options below ----
      # A) Atlas (preferred): filled from .env
      - SPRING_DATA_MONGODB_URI=${SPRING_DATA_MONGODB_URI}
      # B) Local Mongo (profile local-mongo): uncomment the line below and comment Atlas line above
      # - SPRING_DATA_MONGODB_URI=mongodb://mongo:27017/houseiq_db

      # ---- ML service base URL (container-to-container) ----
      - ML_BASE_URL=http://ml:8000

      # ---- JWT secret + TTL ----
      - JWT_SECRET=${JWT_SECRET}
      - JWT_TTL_SECONDS=${JWT_TTL_SECONDS:-86400}

      # Optional: Spring port override
      - SERVER_PORT=8080
    ports:
      - "8080:8080"

  frontend:
    build:
      context: ../houseiq-frontend
    container_name: houseiq-frontend
    ports:
      - "5173:5173"
    environment:
      # Backend API URL for frontend to connect to (must include /api)
      - VITE_API_URL=http://localhost:8080/api
    depends_on:
      - backend
